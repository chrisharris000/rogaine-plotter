import math
from pathlib import Path

import pandas as pd

from utils import TeamResult, CONTROL_COORDINATES

class Reader:
    """
    Import results of rogaine event from original txt files or from csv generated by this program
    """
    def __init__(self, config: dict):
        self.config = config

    def parse_txt_results_directory(self) -> TeamResult:
        """
        Parse the original txt files of results into a dictionary of team_number:team_result
        """
        pass

    def _parse_txt_result(self, filepath: Path) -> TeamResult:
        """
        Parse an individual txt result file
        """
        result = pd.DataFrame(columns = ["control",
                                         "cumulative_points",
                                         "time_split",
                                         "distance_travelled"])
        
        # get team number from file name (X_ZZZZ.txt) where X is team number, ZZZZ is wristband ID
        filename = filepath.name
        team_number = filename.split("_")[0]

        for line_num, line in enumerate(open(filepath)):
            # ignore first 3 lines, only descriptive info about file
            if line_num < 3:
                continue

            # ignore line starting with No and Distance and newline:
            if line.startswith("No") or line.startswith("Distance") or line == "\n":
                continue

            # extract relevant fields
            _no, control, _time, _dist, _cm_dist, cumulative_points, time_split, *_other_fields = line.lstrip().split()

            # pad time with zero hours if necessary
            if time_split.count(":") == 1:
                time_split = "00:" + time_split

            # calculate distance travelled
            prev_control = ""
            if len(result) == 0:
                prev_control = "HH"
            else:
                prev_entry = result.loc[len(result) - 1]
                prev_control = prev_entry["control"]

            distance_travelled = self._calculate_distance_travelled(prev_control, control)

            entry = [control, int(float(cumulative_points)), pd.Timedelta(time_split), distance_travelled]
            result.loc[len(result)] = entry

        return TeamResult(team_number, result)

    def parse_csv_results_directory(self) -> TeamResult:
        """
        Parse the results from csv files generated by this class
        """
        pass

    def _parser_csv_result(self) -> TeamResult:
        """
        Parse an individual csv result
        """
        pass

    def write_csv_results(self) -> None:
        """
        Write the results dataframes as csv files
        """
        pass

    def _calculate_distance_travelled(self, prev_control: str, curr_control: str) -> float:
        """
        Calculate the distance in km between the previous control and the current control
        """
        prev_control_coords = CONTROL_COORDINATES[prev_control]
        curr_control_coords = CONTROL_COORDINATES[curr_control]
        dx = prev_control_coords.x - curr_control_coords.x
        dy = prev_control_coords.y - curr_control_coords.y
        dist = math.sqrt(dx**2 + dy**2)
        return dist
